The primary issue is that the user popup (`#user-popup`) does not reliably appear only when clicking the user avatar (`#user-avatar`). The provided code already includes a `setupUserPopup` function to handle this behavior, but there are a few areas where improvements are needed to ensure the popup toggles correctly and consistently. Additionally, the duplicate `initializeDashboard` function needs to be resolved, and the logout button in the popup needs to be wired up. Below is the fully fixed HTML, CSS, and JavaScript code, incorporating the previous suggestions and ensuring the user popup only appears on avatar click.

### Key Fixes
1. **User Popup Behavior**:
   - Ensured `#user-popup` is hidden by default with `display: none` in CSS and only shown with `.active` class (`display: flex`).
   - Refined `setupUserPopup` to prevent duplicate event listeners and handle clicks correctly.
   - Added event listener for the popup's logout button (`#popup-logout-btn`) to call `handleLogout`.
2. **Removed Duplicate `initializeDashboard`**:
   - Consolidated the two `initializeDashboard` functions into a single one to avoid redundancy.
3. **CSS Consistency**:
   - Ensured `.user-popup` CSS aligns with mobile responsiveness and visibility rules.
4. **JavaScript Robustness**:
   - Added checks to prevent errors if elements are missing.
   - Improved event delegation to avoid conflicts with other UI elements.

### Fully Fixed Code
Below is the complete, corrected code. The changes are integrated into the provided HTML, CSS, and JavaScript, with no other modifications beyond what's necessary to address the user popup issue and remove the duplicate function.

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Prevent Caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="-1" />
  <meta http-equiv="Vary" content="*" />
  <base href="https://hipotech-dev.github.io/MyMemory/">
  <title>MyMemory - Your Personal Productivity App</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #003087;
      --primary-light: #0070ba;
      --secondary: #ff5a5f;
      --dark: #2d3748;
      --light: #f5f7fa;
      --gray: #e2e8f0;
      --success: #38a169;
      --white: #ffffff;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--light);
    }

    /* Authentication Page Styles */
    .auth-page {
      background: url('hipo.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
      position: relative;
    }
    
    .auth-container {
      background: var(--white);
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      margin: 1rem;
      transition: transform 0.3s ease;
    }
    
    .auth-container:hover {
      transform: translateY(-5px);
    }
    
    .auth-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: linear-gradient(to right, var(--primary), var(--primary-light));
    }
    
    .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .logo img {
      height: 60px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }
    
    .logo img[src=""] {
      background: url('amnesia.png') no-repeat center;
      background-size: contain;
      height: 60px;
      width: 60px;
    }
    
    .logo h1 {
      color: var(--primary);
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    
    /* Message Styles */
    .message {
      display: none;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      text-align: center;
      animation: slideIn 0.3s ease;
    }
    
    .message.success {
      background: var(--success);
      color: var(--white);
    }
    
    .message.error {
      background: var(--secondary);
      color: var(--white);
    }
    
    /* Form Validation Error */
    .error-text {
      color: var(--secondary);
      font-size: 0.8rem;
      margin-top: 0.5rem;
      display: none;
    }
    
    .form-group.invalid input {
      border-color: var(--secondary);
    }
    
    .form-group.invalid .error-text {
      display: block;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .input-icon {
      position: absolute;
      left: 1rem;
      top: 2.5rem;
      color: #6b7280;
      font-size: 1.1rem;
    }
    
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width: 100%;
      padding: 0.75rem 0.75rem 0.75rem 2.5rem;
      border: 1px solid var(--gray);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fafafa;
    }
    
    input:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(0, 112, 186, 0.2);
      background: var(--white);
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 1rem;
      background: var(--primary);
      border: none;
      color: var(--white);
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .btn:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    /* Social Login */
    .social-login {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .social-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--white);
      border: 1px solid var(--gray);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .social-btn:hover {
      background: var(--light);
      transform: scale(1.1);
    }
    
    .social-btn i {
      font-size: 1.3rem;
      color: var(--dark);
    }
    
    /* Password Actions */
    .password-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    
    .remember-me {
      display: flex;
      align-items: center;
      color: var(--dark);
    }
    
    .remember-me input {
      margin-right: 0.5rem;
      width: 1.2rem;
      height: 1.2rem;
    }
    
    .forgot-password a {
      color: var(--primary);
      text-decoration: none;
      transition: all 0.3s;
    }
    
    .forgot-password a:hover {
      text-decoration: underline;
    }
    
    /* Divider */
    .divider {
      display: flex;
      align-items: center;
      margin: 1.5rem 0;
      color: #6b7280;
      font-size: 0.9rem;
    }
    
    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid var(--gray);
    }
    
    .divider::before {
      margin-right: 1rem;
    }
    
    .divider::after {
      margin-left: 1rem;
    }
    
    /* Switch Link */
    .switch {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.95rem;
      color: var(--dark);
    }
    
    .switch a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .switch a:hover {
      text-decoration: underline;
    }
    
    /* Terms */
    .terms {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 1.5rem;
      text-align: center;
    }
    
    .terms a {
      color: var(--primary);
      text-decoration: none;
    }
    
    .terms a:hover {
      text-decoration: underline;
    }
    
    /* Animations */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: slideIn 0.3s ease-out;
    }
    
    /* Dashboard Styles */
    .dashboard {
      background: url('hipo.jpg') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: var(--white);
      padding: 1rem 2rem;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header .logo {
      flex-direction: row;
      align-items: center;
      gap: 1rem;
    }
    
    .header .logo img {
      height: 50px;
    }
    
    .header .logo img[src=""] {
      height: 50px;
      width: 50px;
    }
    
    .header .logo h1 {
      font-size: 1.6rem;
      color: var(--primary);
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      background: var(--primary);
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .user-avatar:hover {
      background: var(--primary-light);
      transform: scale(1.1);
    }
    
    /* User Popup Styles */
    .user-popup {
      display: none; /* Hidden by default */
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 1rem;
      width: 180px;
      right: 10px;
      top: 45px;
      background: var(--white);
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1001;
      animation: slideIn 0.2s ease-out;
      position: absolute;
    }

    .user-popup.active {
      display: flex; /* Show when active */
    }

    .user-popup .user-info {
      margin-bottom: 0.75rem;
    }

    .user-popup .user-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.25rem;
    }

    .user-popup .user-email {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }

    .user-popup .logout-btn {
      width: 80%;
      padding: 0.5rem;
      background: var(--secondary);
      border: none;
      color: var(--white);
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-popup .logout-btn:hover {
      background: #e53e3e;
      transform: translateY(-1px);
    }

    /* Mobile-specific adjustments */
    @media (max-width: 768px) {
      .user-popup {
        width: 160px;
        right: 5px;
        top: 40px;
        padding: 0.75rem;
      }

      .user-popup .user-name {
        font-size: 0.95rem;
      }

      .user-popup .user-email {
        font-size: 0.75rem;
      }

      .user-popup .logout-btn {
        width: 85%;
        padding: 0.4rem;
        font-size: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      .user-popup {
        width: 140px;
        right: 5px;
        top: 38px;
        padding: 0.6rem;
      }

      .user-popup .user-name {
        font-size: 0.9rem;
      }

      .user-popup .user-email {
        font-size: 0.7rem;
      }

      .user-popup .logout-btn {
        width: 90%;
        padding: 0.35rem;
        font-size: 0.75rem;
      }
    }

    .container {
      display: flex;
      flex: 1;
      padding: 2rem;
      gap: 2rem;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }
    
    .sidebar {
      width: 250px;
      background: var(--primary);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: var(--shadow);
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
    }
    
    .sidebar-menu li {
      margin-bottom: 0.5rem;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: var(--white);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      font-weight: 500;
    }
    
    .sidebar-menu a:hover {
      background: var(--primary-light);
      transform: translateX(5px);
    }
    
    .sidebar-menu a.active {
      background: var(--white);
      color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar-menu a i {
      font-size: 1.1rem;
    }
    
    .main-content {
      flex: 1;
      background: var(--white);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: var(--shadow);
    }
    
    .welcome-banner {
      background: linear-gradient(to right, var(--primary), var(--primary-light));
      color: var(--white);
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
    }
    
    .welcome-banner h2 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
    }
    
    .welcome-banner p {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }
    
    .card {
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      padding: 1.5rem;
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .card-header h3 {
      font-size: 1.3rem;
      color: var(--dark);
    }
    
    .card-header .btn {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
    
    .todo-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .todo-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--light);
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .todo-item:hover {
      background: var(--gray);
    }
    
    .todo-item.todo-completed .todo-text {
      text-decoration: line-through;
      opacity: 0.6;
    }
    
    .todo-checkbox {
      width: 1.2rem;
      height: 1.2rem;
      cursor: pointer;
    }
    
    .todo-text {
      flex: 1;
      font-size: 0.95rem;
      color: var(--dark);
    }
    
    .todo-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .todo-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--dark);
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .todo-actions button:hover {
      color: var(--primary);
    }
    
    .edit-todo-form {
      display: none;
      flex: 1;
      gap: 0.5rem;
      align-items: center;
    }
    
    .edit-todo-input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--gray);
      border-radius: 6px;
      font-size: 0.95rem;
    }
    
    .edit-todo-form button {
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      border-radius: 6px;
    }
    
    .save-edit-btn {
      background: var(--success);
      color: var(--white);
    }
    
    .cancel-edit-btn {
      background: var(--secondary);
      color: var(--white);
    }
    
    .password-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .password-item {
      padding: 0.75rem;
      background: var(--light);
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .password-item:hover {
      background: var(--gray);
    }
    
    .password-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.25rem;
    }
    
    .password-details {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #4a5568;
    }
    
    .password-username,
    .password-value {
      flex: 1;
    }
    
    .toggle-password-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--dark);
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .toggle-password-btn:hover {
      color: var(--primary);
    }
    
    .document-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .document-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--light);
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .document-item:hover {
      background: var(--gray);
    }
    
    .document-icon {
      font-size: 1.5rem;
      color: var(--primary);
    }
    
    .document-info {
      flex: 1;
    }
    
    .document-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--dark);
    }
    
    .document-meta {
      font-size: 0.85rem;
      color: #4a5568;
    }
    
    .document-item button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--dark);
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .document-item button:hover {
      color: var(--primary);
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: var(--white);
      padding: 1.5rem;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .modal-header h3 {
      font-size: 1.3rem;
      color: var(--dark);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--dark);
    }
    
    .modal-close:hover {
      color: var(--secondary);
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--gray);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(0, 112, 186, 0.2);
    }
    
    /* Mobile-Specific Styles */
    @media (max-width: 768px) {
      .auth-page {
        padding: 1rem;
      }
      
      .auth-container {
        max-width: 95%;
        padding: 1.5rem;
        border-radius: 16px;
      }
      
      .logo img {
        height: 50px;
      }
      
      .logo img[src=""] {
        height: 50px;
        width: 50px;
      }
      
      .logo h1 {
        font-size: 1.5rem;
      }
      
      .form-group {
        margin-bottom: 1.25rem;
      }
      
      input[type="email"],
      input[type="password"],
      input[type="text"] {
        padding: 0.75rem 0.75rem 0.75rem 2.5rem;
        font-size: 0.95rem;
      }
      
      .input-icon {
        top: 2.4rem;
      }
      
      .btn {
        padding: 0.9rem;
        font-size: 0.95rem;
      }
      
      .social-btn {
        width: 45px;
        height: 45px;
      }
      
      .social-btn i {
        font-size: 1.2rem;
      }
      
      .password-actions {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }
      
      .container {
        flex-direction: column;
        padding: 1rem;
      }
      
      .sidebar {
        width: 100%;
        border-radius: 10px;
        padding: 1rem;
      }
      
      .sidebar-menu {
        display: flex;
        overflow-x: auto;
        padding-bottom: 5px;
        gap: 5px;
      }
      
      .sidebar-menu li {
        margin-bottom: 0;
      }
      
      .sidebar-menu a {
        white-space: nowrap;
        padding: 0.5rem;
        font-size: 0.9rem;
      }
      
      .main-content {
        padding: 1.5rem;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .header {
        padding: 1rem;
      }
      
      .header .logo img {
        height: 40px;
      }
      
      .header .logo img[src=""] {
        height: 40px;
        width: 40px;
      }
      
      .header .logo h1 {
        font-size: 1.4rem;
      }
      
      .user-popup {
        width: 180px;
        top: 45px;
        right: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .auth-container {
        padding: 1.25rem;
      }
      
      .logo img {
        height: 45px;
      }
      
      .logo img[src=""] {
        height: 45px;
        width: 45px;
      }
      
      .logo h1 {
        font-size: 1.3rem;
      }
      
      .form-group {
        margin-bottom: 1rem;
      }
      
      .btn {
        padding: 0.8rem;
        font-size: 0.9rem;
      }
      
      .social-login {
        gap: 0.75rem;
      }
      
      .social-btn {
        width: 40px;
        height: 40px;
      }
      
      .social-btn i {
        font-size: 1.1rem;
      }
      
      .divider {
        font-size: 0.85rem;
      }
      
      .switch {
        font-size: 0.9rem;
      }
      
      .terms {
        font-size: 0.8rem;
      }
      
      .welcome-banner h2 {
        font-size: 1.4rem;
      }
      
      .welcome-banner p {
        font-size: 0.9rem;
      }
      
      .card {
        padding: 1rem;
      }
      
      .card-header h3 {
        font-size: 1.2rem;
      }
      
      .user-popup {
        width: 160px;
        top: 40px;
        right: 5px;
      }
    }

    /* Prevent horizontal scrolling */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    /* Better touch targets for mobile */
    button, a, input[type="checkbox"] {
      touch-action: manipulation;
    }
    
    .resend-verification {
      text-align: center;
      margin: 1rem 0;
      font-size: 0.85rem;
    }

    .resend-verification a {
      color: var(--primary);
      text-decoration: none;
      transition: all 0.3s;
    }

    .resend-verification a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- Authentication Page (shown by default) -->
  <div class="auth-page" id="auth-page">
    <div class="auth-container" id="login-form">
      <div class="logo">
        <img src="amnesia.png" alt="MyMemory Logo">
        <h1>MyMemory</h1>
      </div>
      <div class="message" id="login-message"></div>
      <form id="login">
        <div class="form-group" id="email-group">
          <label for="email">Email Address</label>
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" id="email" placeholder="you@example.com" required />
          <div class="error-text" id="email-error"></div>
        </div>
        
        <div class="form-group" id="password-group">
          <label for="password">Password</label>
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="password" placeholder="••••••••" required />
          <div class="error-text" id="password-error"></div>
          <div class="password-actions">
            <div class="remember-me">
              <input type="checkbox" id="remember" checked>
              <label for="remember">Remember me</label>
            </div>
            <div class="forgot-password">
              <a href="#" id="forgot-password">Forgot password?</a>
            </div>
          </div>
        </div>
        <div class="resend-verification">
          <a href="#" id="resend-verification">Resend Verification Email</a>
        </div>
        <button type="submit" class="btn">Log In</button>
      </form>
      <div class="switch">
        Don't have an account?
        <a href="#" onclick="toggleForms()">Sign Up</a>
      </div>
    </div>

    <div class="auth-container" id="signup-form" style="display: none;">
      <div class="logo">
        <img src="amnesia.png" alt="MyMemory Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/7660/7660733.png'">
        <h1>MyMemory</h1>
      </div>
      
      <h2>Create Account</h2>
      <div class="message" id="signup-message"></div>
      
      <form id="signup">
        <div class="form-group" id="name-group">
          <label for="name">Full Name</label>
          <i class="fas fa-user input-icon"></i>
          <input type="text" id="name" placeholder="John Doe" required />
          <div class="error-text" id="name-error"></div>
        </div>
        
        <div class="form-group" id="email-signup-group">
          <label for="email-signup">Email Address</label>
          <i class="fas fa-envelope input-icon"></i>
          <input type="email" id="email-signup" placeholder="you@example.com" required />
          <div class="error-text" id="email-signup-error"></div>
        </div>
        
        <div class="form-group" id="password-signup-group">
          <label for="password-signup">Password</label>
          <i class="fas fa-lock input-icon"></i>
          <input type="password" id="password-signup" placeholder="Create a password" required />
          <div class="error-text" id="password-signup-error"></div>
          <div class="password-strength">
            <div class="strength-meter" id="strength-meter"></div>
          </div>
        </div>
        
        <button type="submit" class="btn">Sign Up</button>
      </form>
      
      <div class="terms">
        By signing up, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>.
      </div>
      
      <div class="switch">
        Already have an account?
        <a href="#" onclick="toggleForms()">Log In</a>
      </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal" id="forgot-password-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Reset Password</h3>
          <button class="modal-close">×</button>
        </div>
        <div class="message" id="forgot-message"></div>
        <form id="forgot-password-form">
          <div class="form-group" id="forgot-email-group">
            <label for="forgot-email">Email Address</label>
            <i class="fas fa-envelope input-icon"></i>
            <input type="email" id="forgot-email" class="form-control" placeholder="you@example.com" required>
            <div class="error-text" id="forgot-email-error"></div>
          </div>
          <button type="submit" class="btn">Send Reset Email</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard" id="dashboard" style="display: none;">
    <header class="header">
      <div class="logo">
        <img src="amnesia.png" alt="MyMemory Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/7660/7660733.png'">
        <h1>MyMemory</h1>
      </div>
      <div class="user-menu">
        <div class="user-avatar" id="user-avatar">JS</div>
        <div class="user-popup" id="user-popup">
          <div class="user-info">
            <div class="user-name" id="popup-user-name">John Smith</div>
            <div class="user-email" id="popup-user-email">john.smith@example.com</div>
          </div>
          <button class="logout-btn" id="popup-logout-btn">Logout</button>
        </div>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <ul class="sidebar-menu">
          <li><a href="index.html" class="active" id="dashboard-link"><i class="fas fa-home"></i> Dashboard</a></li>
          <li><a href="To do list.html" id="todo-link"><i class="fas fa-tasks"></i> To-Do List</a></li>
          <li><a href="Password Manager.html" id="password-link"><i class="fas fa-lock"></i> Password Manager</a></li>
          <li><a href="Documents.html" id="documents-link"><i class="fas fa-file-contract"></i> Documents</a></li>
          <li><a href="Settings.html" id="settings-link"><i class="fas fa-cog"></i> Settings</a></li>
          <li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
      </aside>

      <main class="main-content">
        <div class="welcome-banner">
          <h2>Welcome back, <span id="user-name">John Smith</span>!</h2>
          <p>Here's what's happening with your account today.</p>
        </div>

        <div class="dashboard-cards">
          <div class="card">
            <div class="card-header">
              <h3>To-Do List</h3>
              <button class="btn" id="add-todo-btn">Add Item</button>
            </div>
            <div class="todo-list" id="todo-list">
              <div class="todo-item">
                <input type="checkbox" class="todo-checkbox">
                <div class="todo-text">Complete project proposal</div>
                <div class="todo-actions">
                  <button class="edit-todo-btn"><i class="fas fa-edit"></i></button>
                  <button class="delete-todo-btn"><i class="fas fa-trash"></i></button>
                </div>
                <div class="edit-todo-form">
                  <input type="text" class="edit-todo-input" value="Complete project proposal">
                  <button class="save-edit-btn">Save</button>
                  <button class="cancel-edit-btn">Cancel</button>
                </div>
              </div>
              <div class="todo-item todo-completed">
                <input type="checkbox" class="todo-checkbox" checked>
                <div class="todo-text">Meeting with client</div>
                <div class="todo-actions">
                  <button class="edit-todo-btn"><i class="fas fa-edit"></i></button>
                  <button class="delete-todo-btn"><i class="fas fa-trash"></i></button>
                </div>
                <div class="edit-todo-form">
                  <input type="text" class="edit-todo-input" value="Meeting with client">
                  <button class="save-edit-btn">Save</button>
                  <button class="cancel-edit-btn">Cancel</button>
                </div>
              </div>
              <div class="todo-item">
                <input type="checkbox" class="todo-checkbox">
                <div class="todo-text">Review contract documents</div>
                <div class="todo-actions">
                  <button class="edit-todo-btn"><i class="fas fa-edit"></i></button>
                  <button class="delete-todo-btn"><i class="fas fa-trash"></i></button>
                </div>
                <div class="edit-todo-form">
                  <input type="text" class="edit-todo-input" value="Review contract documents">
                  <button class="save-edit-btn">Save</button>
                  <button class="cancel-edit-btn">Cancel</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Password Manager</h3>
              <button class="btn" id="add-password-btn">Add Password</button>
            </div>
            <div class="password-list" id="password-list">
              <div class="password-item">
                <div class="password-title">Email Account</div>
                <div class="password-details">
                  <span class="password-username">john.smith@example.com</span>
                  <span class="password-value" style="display: none;">emailPassword123</span>
                  <button class="toggle-password-btn"><i class="fas fa-eye"></i></button>
                </div>
              </div>
              <div class="password-item">
                <div class="password-title">Bank Account</div>
                <div class="password-details">
                  <span class="password-username">*******1234</span>
                  <span class="password-value" style="display: none;">bankPassword456</span>
                  <button class="toggle-password-btn"><i class="fas fa-eye"></i></button>
                </div>
              </div>
              <div class="password-item">
                <div class="password-title">Server Access</div>
                <div class="password-details">
                  <span class="password-username">admin@server</span>
                  <span class="password-value" style="display: none;">serverPassword789</span>
                  <button class="toggle-password-btn"><i class="fas fa-eye"></i></button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Recent Documents</h3>
              <button class="btn" id="upload-doc-btn">Upload</button>
            </div>
            <div class="document-list" id="document-list">
              <div class="document-item">
                <i class="fas fa-file-pdf document-icon"></i>
                <div class="document-info">
                  <div class="document-name">Client Contract.pdf</div>
                  <div class="document-meta">Uploaded 2 days ago • 2.4 MB</div>
                </div>
                <button><i class="fas fa-ellipsis-v"></i></button>
              </div>
              <div class="document-item">
                <i class="fas fa-file-word document-icon"></i>
                <div class="document-info">
                  <div class="document-name">Project Proposal.docx</div>
                  <div class="document-meta">Uploaded 1 week ago • 1.1 MB</div>
                </div>
                <button><i class="fas fa-ellipsis-v"></i></button>
              </div>
              <div class="document-item">
                <i class="fas fa-file-excel document-icon"></i>
                <div class="document-info">
                  <div class="document-name">Financial Report.xlsx</div>
                  <div class="document-meta">Uploaded 3 weeks ago • 3.7 MB</div>
                </div>
                <button><i class="fas fa-ellipsis-v"></i></button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Add Todo Modal -->
    <div class="modal" id="todo-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add New Task</h3>
          <button class="modal-close">×</button>
        </div>
        <form id="todo-form">
          <div class="form-group">
            <label for="todo-title">Task Description</label>
            <input type="text" id="todo-title" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="todo-due">Due Date</label>
            <input type="date" id="todo-due" class="form-control">
          </div>
          <button type="submit" class="btn">Save Task</button>
        </form>
      </div>
    </div>

    <!-- Add Password Modal -->
    <div class="modal" id="password-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add New Password</h3>
          <button class="modal-close">×</button>
        </div>
        <form id="password-form">
          <div class="form-group">
            <label for="password-title">Title</label>
            <input type="text" id="password-title" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="password-username">Username/Email</label>
            <input type="text" id="password-username" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="password-value">Password</label>
            <input type="password" id="password-value" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="password-url">Website URL</label>
            <input type="url" id="password-url" class="form-control">
          </div>
          <button type="submit" class="btn">Save Password</button>
        </form>
      </div>
    </div>

    <!-- Upload Document Modal -->
    <div class="modal" id="document-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Upload Document</h3>
          <button class="modal-close">×</button>
        </div>
        <form id="document-form">
          <div class="form-group">
            <label for="document-name">Document Name</label>
            <input type="text" id="document-name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="document-file">Select File</label>
            <input type="file" id="document-file" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="document-category">Category</label>
            <select id="document-category" class="form-control">
              <option value="contract">Contract</option>
              <option value="proposal">Proposal</option>
              <option value="report">Report</option>
              <option value="other">Other</option>
            </select>
          </div>
          <button type="submit" class="btn">Upload Document</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBx6PhrRpMKV4P6MMcWqY4M8VkntAc1678",
      authDomain: "mymemory-ddc21.firebaseapp.com",
      projectId: "mymemory-ddc21",
      storageBucket: "mymemory-ddc21.firebasestorage.app",
      messagingSenderId: "875926928384",
      appId: "1:875926928384:web:57c38b56f24ecb4a3dace5",
      measurementId: "G-8XZZNJB0QD"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Enable email verification
    auth.useDeviceLanguage();

    // Show message (success or error)
    function showMessage(elementId, message, type = 'success') {
      const messageElement = document.getElementById(elementId);
      if (messageElement) {
        messageElement.textContent = message;
        messageElement.className = `message ${type}`;
        messageElement.style.display = 'block';
        setTimeout(() => {
          messageElement.style.display = 'none';
        }, 5000);
      }
    }

    // Validate email format
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Validate URL format
    function isValidUrl(url) {
      try {
        new URL(url);
        return true;
      } catch {
        return false;
      }
    }

    // Toggle between login and signup forms
    function toggleForms() {
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const loginMessage = document.getElementById('login-message');
      const signupMessage = document.getElementById('signup-message');

      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
        signupMessage.style.display = 'none';
      } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
        loginMessage.style.display = 'none';
      }

      const activeForm = loginForm.style.display === 'none' ? signupForm : loginForm;
      activeForm.classList.add('fade-in');
      setTimeout(() => activeForm.classList.remove('fade-in'), 300);
    }

    // Password strength indicator
    const passwordInput = document.getElementById('password-signup');
    const strengthMeter = document.getElementById('strength-meter');

    if (passwordInput && strengthMeter) {
      passwordInput.addEventListener('input', function() {
        const password = this.value;
        let strength = 0;

        if (password.length >= 8) strength += 25;
        if (password.length >= 12) strength += 25;
        if (/[A-Z]/.test(password)) strength += 15;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^A-Za-z0-9]/.test(password)) strength += 20;

        strengthMeter.style.width = strength + '%';
        strengthMeter.style.backgroundColor = strength < 50 ? '#ff5a5f' : 
                                            strength < 75 ? '#f6ad55' : '#38a169';
      });
    }

    // Form validation functions
    function validateLoginForm() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const emailGroup = document.getElementById('email-group');
      const passwordGroup = document.getElementById('password-group');
      const emailError = document.getElementById('email-error');
      const passwordError = document.getElementById('password-error');
      let isValid = true;

      emailGroup.classList.remove('invalid');
      passwordGroup.classList.remove('invalid');
      emailError.style.display = 'none';
      passwordError.style.display = 'none';

      if (!email) {
        emailError.textContent = 'Email is required';
        emailGroup.classList.add('invalid');
        isValid = false;
      } else if (!isValidEmail(email)) {
        emailError.textContent = 'Please enter a valid email address';
        emailGroup.classList.add('invalid');
        isValid = false;
      }

      if (!password) {
        passwordError.textContent = 'Password is required';
        passwordGroup.classList.add('invalid');
        isValid = false;
      }

      return isValid;
    }

    function validateSignupForm() {
      const name = document.getElementById('name').value;
      const email = document.getElementById('email-signup').value;
      const password = document.getElementById('password-signup').value;
      const nameGroup = document.getElementById('name-group');
      const emailGroup = document.getElementById('email-signup-group');
      const passwordGroup = document.getElementById('password-signup-group');
      const nameError = document.getElementById('name-error');
      const emailError = document.getElementById('email-signup-error');
      const passwordError = document.getElementById('password-signup-error');
      let isValid = true;

      nameGroup.classList.remove('invalid');
      emailGroup.classList.remove('invalid');
      passwordGroup.classList.remove('invalid');
      nameError.style.display = 'none';
      emailError.style.display = 'none';
      passwordError.style.display = 'none';

      if (!name) {
        nameError.textContent = 'Full name is required';
        nameGroup.classList.add('invalid');
        isValid = false;
      }

      if (!email) {
        emailError.textContent = 'Email is required';
        emailGroup.classList.add('invalid');
        isValid = false;
      } else if (!isValidEmail(email)) {
        emailError.textContent = 'Please enter a valid email address';
        emailGroup.classList.add('invalid');
        isValid = false;
      }

      if (!password) {
        passwordError.textContent = 'Password is required';
        passwordGroup.classList.add('invalid');
        isValid = false;
      } else if (password.length < 8) {
        passwordError.textContent = 'Password must be at least 8 characters';
        passwordGroup.classList.add('invalid');
        isValid = false;
      }

      return isValid;
    }

    function validateForgotForm() {
      const email = document.getElementById('forgot-email').value;
      const emailGroup = document.getElementById('forgot-email-group');
      const emailError = document.getElementById('forgot-email-error');
      let isValid = true;

      emailGroup.classList.remove('invalid');
      emailError.style.display = 'none';

      if (!email) {
        emailError.textContent = 'Email is required';
        emailGroup.classList.add('invalid');
        isValid = false;
      } else if (!isValidEmail(email)) {
        emailError.textContent = 'Please enter a valid email address';
        emailGroup.classList.add('invalid');
        isValid = false;
      }

      return isValid;
    }

    function validateTodoForm() {
      const title = document.getElementById('todo-title').value;
      const dueDate = document.getElementById('todo-due').value;
      const titleGroup = document.getElementById('todo-title').parentElement;
      let isValid = true;

      titleGroup.classList.remove('invalid');
      titleGroup.querySelector('.error-text')?.remove();

      if (!title.trim()) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Task description is required';
        titleGroup.appendChild(errorText);
        titleGroup.classList.add('invalid');
        isValid = false;
      }

      if (dueDate && new Date(dueDate) < new Date()) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Due date cannot be in the past';
        document.getElementById('todo-due').parentElement.appendChild(errorText);
        isValid = false;
      }

      return isValid;
    }

    function validatePasswordForm() {
      const title = document.getElementById('password-title').value;
      const username = document.getElementById('password-username').value;
      const password = document.getElementById('password-value').value;
      const url = document.getElementById('password-url').value;
      const titleGroup = document.getElementById('password-title').parentElement;
      const usernameGroup = document.getElementById('password-username').parentElement;
      const passwordGroup = document.getElementById('password-value').parentElement;
      const urlGroup = document.getElementById('password-url').parentElement;
      let isValid = true;

      [titleGroup, usernameGroup, passwordGroup, urlGroup].forEach(group => {
        group.classList.remove('invalid');
        group.querySelector('.error-text')?.remove();
      });

      if (!title.trim()) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Title is required';
        titleGroup.appendChild(errorText);
        titleGroup.classList.add('invalid');
        isValid = false;
      }

      if (!username.trim()) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Username or email is required';
        usernameGroup.appendChild(errorText);
        usernameGroup.classList.add('invalid');
        isValid = false;
      }

      if (!password.trim()) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Password is required';
        passwordGroup.appendChild(errorText);
        passwordGroup.classList.add('invalid');
        isValid = false;
      }

      if (url && !isValidUrl(url)) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Please enter a valid URL';
        urlGroup.appendChild(errorText);
        urlGroup.classList.add('invalid');
        isValid = false;
      }

      return isValid;
    }

    function validateDocumentForm() {
      const name = document.getElementById('document-name').value;
      const file = document.getElementById('document-file').files[0];
      const nameGroup = document.getElementById('document-name').parentElement;
      const fileGroup = document.getElementById('document-file').parentElement;
      let isValid = true;

      [nameGroup, fileGroup].forEach(group => {
        group.classList.remove('invalid');
        group.querySelector('.error-text')?.remove();
      });

      if (!name.trim()) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Document name is required';
        nameGroup.appendChild(errorText);
        nameGroup.classList.add('invalid');
        isValid = false;
      }

      if (!file) {
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'Please select a file';
        fileGroup.appendChild(errorText);
        fileGroup.classList.add('invalid');
        isValid = false;
      } else if (file.size > 5 * 1024 * 1024) { // 5MB limit
        const errorText = document.createElement('div');
        errorText.className = 'error-text';
        errorText.textContent = 'File size must be less than 5MB';
        fileGroup.appendChild(errorText);
        fileGroup.classList.add('invalid');
        isValid = false;
      }

      return isValid;
    }

    // Rate limiting for password reset and verification email
    const RATE_LIMIT_MS = 30 * 1000; // 30 seconds

    function canSendPasswordReset(email) {
      const lastReset = localStorage.getItem(`reset-attempt-${email}`);
      if (!lastReset) return true;
      const timeSinceLast = Date.now() - parseInt(lastReset);
      return timeSinceLast > RATE_LIMIT_MS;
    }

    function canResendVerification(email) {
      const lastAttempt = localStorage.getItem(`verification-attempt-${email}`);
      if (!lastAttempt) return true;
      const timeSinceLast = Date.now() - parseInt(lastAttempt);
      return timeSinceLast > RATE_LIMIT_MS;
    }

    // Persist todos to localStorage
    function saveTodos() {
      const todos = [];
      document.querySelectorAll('.todo-item').forEach(item => {
        todos.push({
          text: item.querySelector('.todo-text').textContent,
          completed: item.classList.contains('todo-completed')
        });
      });
      localStorage.setItem('todos', JSON.stringify(todos));
    }

    function loadTodos() {
      const todos = JSON.parse(localStorage.getItem('todos') || '[]');
      const todoList = document.getElementById('todo-list');
      todoList.innerHTML = ''; // Clear existing todos
      todos.forEach(todo => {
        const todoItem = document.createElement('div');
        todoItem.className = `todo-item ${todo.completed ? 'todo-completed' : ''}`;
        todoItem.innerHTML = `
          <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''}>
          <div class="todo-text">${todo.text}</div>
          <div class="todo-actions">
            <button class="edit-todo-btn"><i class="fas fa-edit"></i></button>
            <button class="delete-todo-btn"><i class="fas fa-trash"></i></button>
          </div>
          <div class="edit-todo-form">
            <input type="text" class="edit-todo-input" value="${todo.text}">
            <button class="save-edit-btn">Save</button>
            <button class="cancel-edit-btn">Cancel</button>
          </div>
        `;
        todoList.prepend(todoItem);
        addTodoEventListeners(todoItem);
      });
    }

    // Check authentication state on page load
    function checkAuthOnLoad() {
      return new Promise((resolve) => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          unsubscribe();
          if (user && user.emailVerified) {
            const userData = {
              name: user.displayName || user.email.split('@')[0],
              email: user.email,
              avatarInitials: (user.displayName || user.email).substring(0, 2).toUpperCase()
            };
            localStorage.setItem('userData', JSON.stringify(userData));
            localStorage.setItem('isAuthenticated', 'true');
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            initializeDashboard(userData);
            resolve(true);
          } else {
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('userData');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('auth-page').style.display = 'flex';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            resolve(false);
          }
        }, (error) => {
          showMessage('login-message', 'Authentication error: ' + error.message, 'error');
          document.getElementById('dashboard').style.display = 'none';
          document.getElementById('auth-page').style.display = 'flex';
          document.getElementById('login-form').style.display = 'block';
          document.getElementById('signup-form').style.display = 'none';
          resolve(false);
        });
      });
    }

    // Login form submission
    document.getElementById('login').addEventListener('submit', function(e) {
      e.preventDefault();

      if (!validateLoginForm()) return;

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;

      const persistence = remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
      auth.setPersistence(persistence)
        .then(() => {
          auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
              const user = userCredential.user;
              if (!user.emailVerified) {
                if (!canResendVerification(email)) {
                  showMessage('login-message', 'Please wait before requesting another verification email', 'error');
                  auth.signOut();
                  return;
                }
                user.sendEmailVerification({
                  url: 'https://hipotech-dev.github.io/MyMemory/action.html'
                })
                .then(() => {
                  localStorage.setItem(`verification-attempt-${email}`, Date.now());
                  showMessage('login-message', 'Your email is not verified. A new verification email has been sent.', 'error');
                  auth.signOut();
                })
                .catch((error) => {
                  let errorMessage = 'Failed to send verification email';
                  if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many requests. Please try again later';
                  }
                  showMessage('login-message', errorMessage, 'error');
                  auth.signOut();
                });
                return;
              }

              const userData = {
                name: user.displayName || email.split('@')[0],
                email: user.email,
                avatarInitials: (user.displayName || email).substring(0, 2).toUpperCase()
              };

              localStorage.setItem('userData', JSON.stringify(userData));
              localStorage.setItem('isAuthenticated', 'true');
              localStorage.setItem('rememberMe', remember);

              document.getElementById('auth-page').style.display = 'none';
              document.getElementById('dashboard').style.display = 'block';
              initializeDashboard(userData);
            })
            .catch((error) => {
              let errorMessage = 'Login failed';
              switch (error.code) {
                case 'auth/invalid-email':
                  errorMessage = 'Invalid email address';
                  break;
                case 'auth/user-not-found':
                  errorMessage = 'No account found with this email';
                  break;
                case 'auth/wrong-password':
                  errorMessage = 'Incorrect password';
                  break;
                case 'auth/too-many-requests':
                  errorMessage = 'Too many login attempts. Try again later';
                  break;
                case 'auth/invalid-login-credentials':
                  errorMessage = 'Invalid email or password';
                  break;
                default:
                  errorMessage = 'Network or server error';
              }
              showMessage('login-message', errorMessage, 'error');
            });
        })
        .catch((error) => {
          showMessage('login-message', 'Error setting session: ' + error.message, 'error');
        });
    });

    // Signup form submission
    document.getElementById('signup').addEventListener('submit', function(e) {
      e.preventDefault();

      if (!validateSignupForm()) return;

      const name = document.getElementById('name').value;
      const email = document.getElementById('email-signup').value;
      const password = document.getElementById('password-signup').value;

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;

          return user.updateProfile({
            displayName: name
          }).then(() => {
            return user.sendEmailVerification({
              url: 'https://hipotech-dev.github.io/MyMemory/action.html'
            }).then(() => {
              localStorage.setItem(`verification-attempt-${email}`, Date.now());
              showMessage('signup-message', 'Account created! Please verify your email to log in.', 'success');
              auth.signOut().then(() => {
                localStorage.removeItem('isAuthenticated');
                localStorage.removeItem('userData');
                document.getElementById('auth-page').style.display = 'flex';
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('signup-form').style.display = 'none';
                document.getElementById('signup').reset();
              });
            });
          });
        })
        .catch((error) => {
          let errorMessage = 'Signup failed';
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage = 'Invalid email address';
              break;
            case 'auth/weak-password':
              errorMessage = 'Password must be at least 8 characters';
              break;
            case 'auth/email-already-in-use':
              errorMessage = 'This email is already in use';
              break;
            default:
              errorMessage = 'Network or server error';
          }
          showMessage('signup-message', errorMessage, 'error');
        });
    });

    // Forgot password handler
    document.getElementById('forgot-password').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('forgot-password-modal').style.display = 'flex';
    });

    // Forgot password form submission
    document.getElementById('forgot-password-form').addEventListener('submit', function(e) {
      e.preventDefault();

      if (!validateForgotForm()) return;

      const email = document.getElementById('forgot-email').value;

      if (!canSendPasswordReset(email)) {
        showMessage('forgot-message', 'Please wait before requesting another reset email', 'error');
        return;
      }

      auth.sendPasswordResetEmail(email, {
        url: 'https://hipotech-dev.github.io/MyMemory/action.html',
        handleCodeInApp: true
      })
        .then(() => {
          localStorage.setItem(`reset-attempt-${email}`, Date.now());
          showMessage('forgot-message', 'Password reset email sent! Check your inbox.', 'success');
          document.getElementById('forgot-password-form').reset();
          document.getElementById('forgot-password-modal').style.display = 'none';
        })
        .catch((error) => {
          let errorMessage = 'Error sending reset email';
          switch (error.code) {
            case 'auth/invalid-email':
              errorMessage = 'Invalid email address';
              break;
            case 'auth/user-not-found':
              errorMessage = 'No user found with this email';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'Too many requests. Try again later';
              break;
            default:
              errorMessage = 'Error sending reset email';
          }
          showMessage('forgot-message', errorMessage, 'error');
        });
    });

    // Close forgot password modal
    document.getElementById('forgot-password-modal').querySelector('.modal-close').addEventListener('click', function() {
      document.getElementById('forgot-password-modal').style.display = 'none';
    });

    window.addEventListener('click', function(e) {
      if (e.target === document.getElementById('forgot-password-modal')) {
        document.getElementById('forgot-password-modal').style.display = 'none';
      }
    });

    // Resend verification email
    document.getElementById('resend-verification').addEventListener('click', function(e) {
      e.preventDefault();

      const email = document.getElementById('email').value;

      if (!email) {
        showMessage('login-message', 'Please enter your email address', 'error');
        return;
      }

      if (!isValidEmail(email)) {
        showMessage('login-message', 'Please enter a valid email address', 'error');
        return;
      }

      if (!canResendVerification(email)) {
        showMessage('login-message', 'Please wait before requesting another verification email', 'error');
        return;
      }

      auth.signInWithEmailAndPassword(email, document.getElementById('password').value || 'temp')
        .then((userCredential) => {
          const user = userCredential.user;
          if (!user.emailVerified) {
            user.sendEmailVerification({
              url: 'https://hipotech-dev.github.io/MyMemory/action.html'
            })
            .then(() => {
              localStorage.setItem(`verification-attempt-${email}`, Date.now());
              showMessage('login-message', 'Verification email sent. Check your inbox.', 'success');
              auth.signOut();
            })
            .catch((error) => {
              let errorMessage = 'Failed to send verification email';
              if (error.code === 'auth/too-many-requests') {
                errorMessage = 'Too many requests. Please try again later';
              }
              showMessage('login-message', errorMessage, 'error');
              auth.signOut();
            });
          } else {
            showMessage('login-message', 'Email is already verified. Please log in.', 'success');
            auth.signOut();
          }
        })
        .catch((error) => {
          let errorMessage = 'Please log in to resend verification email';
          if (error.code === 'auth/wrong-password') {
            errorMessage = 'Please enter your password to resend verification';
          }
          showMessage('login-message', errorMessage, 'error');
        });
    });

    // Logout handler
    function handleLogout(e) {
      e.preventDefault();
      auth.signOut().then(() => {
        localStorage.clear();
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('auth-page').style.display = 'flex';
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('signup-form').style.display = 'none';
        window.location.replace('index.html');
      }).catch((error) => {
        showMessage('login-message', 'Error logging out: ' + error.message, 'error');
      });
    }

    // Sidebar logout link
    document.getElementById('logout-link').addEventListener('click', handleLogout);

    // Toggle user popup only on user avatar click
    function setupUserPopup() {
      const userAvatar = document.getElementById('user-avatar');
      const userPopup = document.getElementById('user-popup');
      const logoutBtn = document.getElementById('popup-logout-btn');

      if (!userAvatar || !userPopup || !logoutBtn) return; // Prevent errors if elements are missing

      // Remove any existing listeners to prevent duplicates
      userAvatar.removeEventListener('click', toggleUserPopup);
      userPopup.removeEventListener('click', stopPropagation);
      window.removeEventListener('click', closeUserPopupOnOutsideClick);
      document.removeEventListener('keydown', closeUserPopupOnEscape);
      logoutBtn.removeEventListener('click', handleLogout);

      // Add click event to toggle popup
      userAvatar.addEventListener('click', toggleUserPopup);

      // Prevent popup clicks from closing the popup
      userPopup.addEventListener('click', stopPropagation);

      // Close popup when clicking outside
      window.addEventListener('click', closeUserPopupOnOutsideClick);

      // Close popup on Escape key
      document.addEventListener('keydown', closeUserPopupOnEscape);

      // Add logout button handler
      logoutBtn.addEventListener('click', handleLogout);

      function toggleUserPopup(e) {
        e.stopPropagation(); // Prevent click from bubbling to window
        userPopup.classList.toggle('active');
      }

      function stopPropagation(e) {
        e.stopPropagation(); // Prevent popup clicks from triggering window click
      }

      function closeUserPopupOnOutsideClick(e) {
        if (!userPopup.contains(e.target) && !userAvatar.contains(e.target)) {
          userPopup.classList.remove('active');
        }
      }

      function closeUserPopupOnEscape(e) {
        if (e.key === 'Escape' && userPopup.classList.contains('active')) {
          userPopup.classList.remove('active');
        }
      }
    }

  // Dashboard initialization
function initializeDashboard(userData) {
  document.getElementById('user-name').textContent = userData.name;
  document.getElementById('user-avatar').textContent = userData.avatarInitials;
  document.getElementById('popup-user-name').textContent = userData.name;
  document.getElementById('popup-user-email').textContent = userData.email;

  loadTodos(); // Load persisted todos

  setupModal('add-todo-btn', 'todo-modal');
  setupModal('add-password-btn', 'password-modal');
  setupModal('upload-doc-btn', 'document-modal');

  document.getElementById('todo-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (validateTodoForm()) {
      addTodoItem();
      saveTodos();
      closeModal('todo-modal');
    }
  });

  document.getElementById('password-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (validatePasswordForm()) {
      addPasswordItem();
      closeModal('password-modal');
    }
  });

  document.getElementById('document-form').addEventListener('submit', function(e) {
    e.preventDefault();
    if (validateDocumentForm()) {
      addDocumentItem();
      closeModal('document-modal');
    }
  });

  document.querySelectorAll('.toggle-password-btn').forEach(button => {
    button.addEventListener('click', function() {
      togglePasswordVisibility(this);
    });
  });

  document.querySelectorAll('.todo-item').forEach(item => {
    addTodoEventListeners(item);
  });

  secureNavigation();
}

function togglePasswordVisibility(button) {
  const passwordDetails = button.closest('.password-details');
  const username = passwordDetails.querySelector('.password-username');
  const password = passwordDetails.querySelector('.password-value');
  const icon = button.querySelector('i');

  if (password.style.display === 'none') {
    username.style.display = 'none';
    password.style.display = 'inline';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    username.style.display = 'inline';
    password.style.display = 'none';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

function setupModal(openBtnId, modalId) {
  const openBtn = document.getElementById(openBtnId);
  const modal = document.getElementById(modalId);
  const closeBtn = modal.querySelector('.modal-close');

  openBtn.addEventListener('click', function() {
    modal.style.display = 'flex';
  });

  closeBtn.addEventListener('click', function() {
    modal.style.display = 'none';
  });

  window.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  document.getElementById(`${modalId.replace('-modal', '-form')}`).reset();
}

function addTodoItem() {
  const title = document.getElementById('todo-title').value;
  const dueDate = document.getElementById('todo-due').value;

  const todoItem = document.createElement('div');
  todoItem.className = 'todo-item';
  todoItem.innerHTML = `
    <input type="checkbox" class="todo-checkbox">
    <div class="todo-text">${title}</div>
    <div class="todo-actions">
      <button class="edit-todo-btn"><i class="fas fa-edit"></i></button>
      <button class="delete-todo-btn"><i class="fas fa-trash"></i></button>
    </div>
    <div class="edit-todo-form">
      <input type="text" class="edit-todo-input" value="${title}">
      <button class="save-edit-btn">Save</button>
      <button class="cancel-edit-btn">Cancel</button>
    </div>
  `;

  document.getElementById('todo-list').prepend(todoItem);
  document.getElementById('todo-form').reset();
  addTodoEventListeners(todoItem);
}

function addPasswordItem() {
  const title = document.getElementById('password-title').value;
  const username = document.getElementById('password-username').value;
  const password = document.getElementById('password-value').value;

  const passwordItem = document.createElement('div');
  passwordItem.className = 'password-item';
  passwordItem.innerHTML = `
    <div class="password-title">${title}</div>
    <div class="password-details">
      <span class="password-username">${username}</span>
      <span class="password-value" style="display: none;">${password}</span>
      <button class="toggle-password-btn"><i class="fas fa-eye"></i></button>
    </div>
  `;

  document.getElementById('password-list').prepend(passwordItem);
  document.getElementById('password-form').reset();

  const toggleBtn = passwordItem.querySelector('.toggle-password-btn');
  toggleBtn.addEventListener('click', function() {
    togglePasswordVisibility(this);
  });
}

function addDocumentItem() {
  const name = document.getElementById('document-name').value;
  const category = document.getElementById('document-category').value;
  const fileInput = document.getElementById('document-file');
  const fileName = fileInput.files[0]?.name || 'Unknown';

  let iconClass = 'fa-file';
  if (fileName.endsWith('.pdf')) iconClass = 'fa-file-pdf';
  if (fileName.endsWith('.docx')) iconClass = 'fa-file-word';
  if (fileName.endsWith('.xlsx')) iconClass = 'fa-file-excel';

  const documentItem = document.createElement('div');
  documentItem.className = 'document-item';
  documentItem.innerHTML = `
    <i class="fas ${iconClass} document-icon"></i>
    <div class="document-info">
      <div class="document-name">${name}</div>
      <div class="document-meta">Uploaded just now • ${category}</div>
    </div>
    <button><i class="fas fa-ellipsis-v"></i></button>
  `;

  document.getElementById('document-list').prepend(documentItem);
  document.getElementById('document-form').reset();
}

function addTodoEventListeners(todoItem) {
  const checkbox = todoItem.querySelector('.todo-checkbox');
  const deleteBtn = todoItem.querySelector('.delete-todo-btn');
  const editBtn = todoItem.querySelector('.edit-todo-btn');
  const editForm = todoItem.querySelector('.edit-todo-form');
  const editInput = todoItem.querySelector('.edit-todo-input');
  const saveEditBtn = todoItem.querySelector('.save-edit-btn');
  const cancelEditBtn = todoItem.querySelector('.cancel-edit-btn');
  const todoText = todoItem.querySelector('.todo-text');

  checkbox.addEventListener('change', function() {
    if (this.checked) {
      todoItem.classList.add('todo-completed');
    } else {
      todoItem.classList.remove('todo-completed');
    }
    saveTodos();
  });

  deleteBtn.addEventListener('click', function() {
    todoItem.remove();
    saveTodos();
  });

  editBtn.addEventListener('click', function() {
    editInput.value = todoText.textContent;
    editForm.style.display = 'flex';
  });

  saveEditBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (editInput.value.trim()) {
      todoText.textContent = editInput.value;
      editForm.style.display = 'none';
      saveTodos();
    }
  });

  cancelEditBtn.addEventListener('click', function(e) {
    e.preventDefault();
    editForm.style.display = 'none';
  });

  editInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && editInput.value.trim()) {
      e.preventDefault();
      todoText.textContent = editInput.value;
      editForm.style.display = 'none';
      saveTodos();
    }
  });
}

function secureNavigation() {
  let isCheckingAuth = false;
  document.querySelectorAll('.sidebar-menu a').forEach(link => {
    if (link.id !== 'logout-link') {
      link.addEventListener('click', async function(e) {
        e.preventDefault();
        const targetUrl = this.getAttribute('href');

        if (isCheckingAuth) return;
        isCheckingAuth = true;

        try {
          const user = await new Promise((resolve, reject) => {
            const unsubscribe = auth.onAuthStateChanged(user => {
              unsubscribe();
              resolve(user);
            }, reject);
          });

          if (user && user.emailVerified && localStorage.getItem('isAuthenticated') === 'true') {
            window.location.href = targetUrl;
          } else {
            showMessage('login-message', 'Please log in to access this page', 'error');
            localStorage.clear();
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('auth-page').style.display = 'flex';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            window.location.href = 'index.html';
          }
        } catch (error) {
          showMessage('login-message', 'Authentication error: ' + error.message, 'error');
          document.getElementById('dashboard').style.display = 'none';
          document.getElementById('auth-page').style.display = 'flex';
          document.getElementById('login-form').style.display = 'block';
          document.getElementById('signup-form').style.display = 'none';
          window.location.href = 'index.html';
        } finally {
          isCheckingAuth = false;
        }
      });
    }
  });
}

// Initialize on page load
checkAuthOnLoad();
</script>
</body>
</html>
