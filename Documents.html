<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Documents | MyMemory</title>
  <!-- Prevent Caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="-1" />
  <meta http-equiv="Vary" content="*" />
  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #003087;
      --primary-light: #0070ba;
      --secondary: #ff5a5f;
      --dark: #2d3748;
      --light: #f5f7fa;
      --gray: #e2e8f0;
      --success: #38a169;
      --white: #ffffff;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Existing styles unchanged */
    /* ... (Previous CSS styles remain the same) ... */

    /* New styles for progress bar */
    .progress-container {
      margin-top: 1rem;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--gray);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--success);
      width: 0;
      transition: width 0.2s ease;
    }
    
    .progress-text {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: var(--dark);
      text-align: center;
    }
    
    /* Disabled button state */
    .btn.disabled {
      background: var(--gray);
      cursor: not-allowed;
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <!-- Message Container for Authentication Errors -->
  <div class="message" id="auth-message"></div>

  <!-- Loading State -->
  <div id="loading">Loading...</div>

  <!-- Main App Content (Hidden by Default) -->
  <div id="app-content">
    <!-- Header and other sections unchanged -->
    <!-- ... (Previous HTML remains the same) ... -->

    <!-- Upload Document Modal -->
    <div class="modal" id="upload-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Upload Document</h3>
          <button class="modal-close">Ã—</button>
        </div>
        <form id="upload-form">
          <div class="form-group">
            <label for="document-name">Document Name</label>
            <input type="text" id="document-name" class="form-control" required>
          </div>
          
          <div class="form-group">
            <label>Select File</label>
            <div class="file-upload" id="file-upload-area">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Drag & drop files here or click to browse</p>
              <input type="file" id="document-file" accept=".pdf,.doc,.docx,.xlsx,.xls,.ppt,.pptx,.jpg,.jpeg,.png,.txt" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="document-category">Category</label>
            <select id="document-category" class="form-control">
              <option value="contract">Contract</option>
              <option value="proposal">Proposal</option>
              <option value="report">Report</option>
              <option value="presentation">Presentation</option>
              <option value="personal">Personal</option>
              <option value="other">Other</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="document-folder">Folder (Optional)</label>
            <select id="document-folder" class="form-control">
              <option value="">None</option>
              <!-- Folders will be added dynamically -->
            </select>
          </div>
          
          <div class="form-group">
            <label for="document-description">Description (Optional)</label>
            <textarea id="document-description" class="form-control" rows="3"></textarea>
          </div>
          
          <!-- Progress Bar -->
          <div class="progress-container" id="upload-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">0%</div>
          </div>
          
          <button type="submit" class="btn" id="upload-submit-btn">
            <i class="fas fa-upload"></i> Upload Document
          </button>
        </form>
      </div>
    </div>

    <!-- Other modals unchanged -->
    <!-- ... (Share, Folder, Preview modals remain the same) ... -->
  </div>

  <script>
    // Firebase configuration and initialization unchanged
    const firebaseConfig = {
      apiKey: "AIzaSyBx6PhrRpMKV4P6MMcWqY4M8VkntAc1678",
      authDomain: "mymemory-ddc21.firebaseapp.com",
      projectId: "mymemory-ddc21",
      storageBucket: "mymemory-ddc21.firebasestorage.app",
      messagingSenderId: "875926928384",
      appId: "1:875926928384:web:57c38b56f24ecb4a3dace5",
      measurementId: "G-8XZZNJB0QD"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Existing functions (showMessage, setupUserPopup, handleLogout, etc.) unchanged
    // ... (Previous JavaScript remains the same up to initializePage) ...

    function initializePage(userData) {
      // Existing initialization code unchanged
      // ... (User avatar, popup, navigation, etc.) ...

      // Document and folder data
      let documents = [];
      let folders = [];
      let currentView = 'table';
      let currentCategory = 'all';
      let currentSearchQuery = '';
      let currentDocumentToShare = null;
      let sortColumn = 'modified';
      let sortDirection = 'desc';

      // Load data, render, and setup functions unchanged
      // ... (loadData, saveData, renderDocuments, renderFolders, etc.) ...

      // Updated uploadDocument function
      async function uploadDocument() {
        const name = document.getElementById('document-name').value.trim();
        const category = document.getElementById('document-category').value;
        const folder = document.getElementById('document-folder').value;
        const description = document.getElementById('document-description').value.trim();
        const fileInput = document.getElementById('document-file');
        const submitBtn = document.getElementById('upload-submit-btn');
        const progressContainer = document.getElementById('upload-progress');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const formInputs = document.querySelectorAll('#upload-form input, #upload-form select, #upload-form textarea');

        if (!name) {
          showMessage('Document name is required.', 'error');
          return;
        }
        
        if (fileInput.files.length === 0) {
          showMessage('Please select a file to upload.', 'error');
          return;
        }
        
        const file = fileInput.files[0];
        const fileType = file.name.split('.').pop().toLowerCase();
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          showMessage('File size exceeds 5MB limit.', 'error');
          return;
        }
        
        const allowedTypes = ['pdf', 'doc', 'docx', 'xlsx', 'xls', 'ppt', 'pptx', 'jpg', 'jpeg', 'png', 'txt'];
        if (!allowedTypes.includes(fileType)) {
          showMessage('Unsupported file type.', 'error');
          return;
        }

        try {
          // Disable form inputs and button during upload
          submitBtn.classList.add('disabled');
          submitBtn.disabled = true;
          formInputs.forEach(input => input.disabled = true);
          
          // Show progress bar
          progressContainer.style.display = 'block';
          progressFill.style.width = '0%';
          progressText.textContent = '0%';

          const storageRef = storage.ref(`documents/${auth.currentUser.uid}/${Date.now()}_${name}.${fileType}`);
          const uploadTask = storageRef.put(file);

          // Monitor upload progress
          uploadTask.on('state_changed',
            (snapshot) => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              progressFill.style.width = `${progress}%`;
              progressText.textContent = `${Math.round(progress)}%`;
              console.log(`Upload progress: ${progress}%`);
            },
            (error) => {
              // Handle errors
              console.error('Upload error:', error);
              showMessage('Error uploading file: ' + error.message, 'error');
              resetUploadForm();
            },
            async () => {
              // Upload complete
              try {
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                console.log('File uploaded successfully, download URL:', downloadURL);

                const newDoc = {
                  id: 'doc' + Date.now(),
                  name: name,
                  type: fileType,
                  category: category,
                  folder: folder,
                  size: file.size,
                  modified: Date.now(),
                  owner: userData.name,
                  shared: false,
                  description: description,
                  storagePath: storageRef.fullPath,
                  downloadURL: downloadURL
                };
                
                documents.unshift(newDoc);
                
                if (folder) {
                  const folderObj = folders.find(f => f.name === folder);
                  if (folderObj) folderObj.files++;
                }
                
                saveData();
                renderDocuments();
                renderFolders();
                populateFolderDropdown();
                
                resetUploadForm();
                showMessage(`Document "${name}.${fileType}" uploaded and stored successfully!`, 'success');
                closeModal('upload-modal');
              } catch (error) {
                console.error('Error getting download URL:', error);
                showMessage('Error finalizing upload.', 'error');
                resetUploadForm();
              }
            }
          );
        } catch (error) {
          console.error('Error initiating upload:', error);
          showMessage('Error initiating upload.', 'error');
          resetUploadForm();
        }

        // Reset form function
        function resetUploadForm() {
          document.getElementById('upload-form').reset();
          submitBtn.classList.remove('disabled');
          submitBtn.disabled = false;
          formInputs.forEach(input => input.disabled = false);
          progressContainer.style.display = 'none';
          progressFill.style.width = '0%';
          progressText.textContent = '0%';
        }
      }

      // Other functions unchanged
      // ... (createFolder, deleteDocument, previewDocument, etc.) ...

      // Initialize additional features
      setupDragAndDrop();
      setupTableSorting();

      // SECURITY WARNING: Storing metadata in localStorage is insecure for production.
      // Use Firebase Firestore for document and folder metadata.
    }
  </script>
</body>
</html>
